# 事务

## 事务特性

A: 原子性（Atomicity）：要么全做，要么全不做

C: 一致性（Consistency）：所有事务在事务执行前后对于一个数据的读取结果都是相同的

I: 隔离性（Isolation）：最终提交前对其它事务不可见

D: 持久性（Durability）：一旦提交，修改会永远保存

只有满足一致性结果才是正确的；无并发时串行执行满足原子性就一定满足一致性；并发时还需要满足隔离性才能满足一致性；持久性是为了应对系统崩溃

## 并发一致性问题

- 丢失修改：两个事务在commit前先后修改，后边会覆盖前边的
- 读脏数据：A事务修改后但是没commit,B事务读了但是A事务回滚了
- 不可重复读：A读->B改->A再读，A两次不一样
- 幻读：不可重读的一种，A读一片范围->B插入->A再读，两次行数不一样

并发可以通过封锁实现，但是封锁需要用户自己控制相当复杂，数据库提供了事务隔离级别来解决

## 封锁

- 写锁：加此锁可以读取和更新，加锁期间别的事务不能对A加任何锁
- 读锁：加此锁只能读，加锁期间其余事务可以加读锁，不能加写锁
- 意向锁：意向锁都是表锁，加读锁前必须先获得意向读锁或更强的锁，加写锁前必须先获得意向写锁

三级封锁协议

- 一级封锁协议

  改数据时必须先加写锁直到事务结束释放，解决丢失修改问题，因为加写锁后就不能两个事务同时改了

- 二级封锁协议

  一级基础上，读时必须加读锁，读完马上释放，解决读脏数据，加读锁后读写隔离开了

- 三级封锁协议

  二级基础上，读时加读锁，直到事务结束才释放，解决不可重读

两段锁协议

加锁和解锁分为两个阶段进行，事务

# 实际开发可copy
## 建表
```sql
CREATE TABLE `ai_sco_day_analyse` (
   `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '自增主键',
   `template_id` varchar(64) NOT NULL DEFAULT '' COMMENT '机器人id',
   `call_date` date NOT NULL DEFAULT '0000-00-00' COMMENT '日期',
   `template_version` varchar(16) NOT NULL DEFAULT '' COMMENT '机器人版本',
   `total_count` int(11) NOT NULL DEFAULT '0' COMMENT '通话总数',
   `through_count` int(11) NOT NULL DEFAULT '0' COMMENT '接通总数',
   `first_round_not_hangup_count` int(11) NOT NULL DEFAULT '0' COMMENT '首轮未挂断总数',
   `cooperate_count` int(11) NOT NULL DEFAULT '0' COMMENT '配合数',
   `success_count` int(11) NOT NULL DEFAULT '0' COMMENT '成功数',
   `see_through_count` int(11) NOT NULL DEFAULT '0' COMMENT '识破数',
   `nlu_distinguish_count` int(11) NOT NULL DEFAULT '0' COMMENT 'nlu实际识别的query数',
   `nlu_eff_count` int(11) NOT NULL DEFAULT '0' COMMENT 'nlu可识别query数',
   `antipathy_count` int(11) NOT NULL DEFAULT '0' COMMENT '反感数',
   `talking_time_len` int(11) NOT NULL DEFAULT '0' COMMENT '通话时长',
   `insert_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '本条记录创建时间',
   `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '本条记录修改时间',
   `is_visible` tinyint(1) NOT NULL DEFAULT '1',
   PRIMARY KEY (`id`),
   UNIQUE KEY `idx_call_date_tenant_id` (`call_date`,`template_id`,`template_version`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4
```

